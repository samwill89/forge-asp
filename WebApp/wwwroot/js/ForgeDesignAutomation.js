/////////////////////////////////////////////////////////////////////
// Copyright (c) Autodesk, Inc. All rights reserved
// Written by Forge Partner Development
//
// Permission to use, copy, modify, and distribute this software in
// object code form for any purpose and without fee is hereby granted,
// provided that the above copyright notice appears in all copies and
// that both that copyright notice and the limited warranty and
// restricted rights notice below appear in all supporting
// documentation.
//
// AUTODESK PROVIDES THIS PROGRAM "AS IS" AND WITH ALL FAULTS.
// AUTODESK SPECIFICALLY DISCLAIMS ANY IMPLIED WARRANTY OF
// MERCHANTABILITY OR FITNESS FOR A PARTICULAR USE.  AUTODESK, INC.
// DOES NOT WARRANT THAT THE OPERATION OF THE PROGRAM WILL BE
// UNINTERRUPTED OR ERROR FREE.
/////////////////////////////////////////////////////////////////////

$(document).ready(function () {

    
    prepareLists();

    //$('#clearAccount').click(clearAccount);
    //$('#defineActivityShow').click(defineActivityModal);
    $('#createAppBundleActivity').click(createAppBundleActivity);
    //$('#startWorkitem').click(startWorkitem);

    startConnection();

    $(".selectBaseMaterial").click(function () {
        currentSelectedBucket = csvData[currentSelectedStyle]['Style'].toLowerCase() + 'bucket';
        console.log(currentSelectedBucket);
        console.log(currentSelectedModel);
        console.log(csvData[currentSelectedStyle]);
        startWorkitem();
    })

    

    document.addEventListener('keydown', event => {
        if (event.keyCode == 65) {    
            currentSelectedBucket = csvData[currentSelectedStyle]['Style'].toLowerCase() + 'bucket';
            console.log(currentSelectedBucket);
            console.log(currentSelectedModel);
            console.log(csvData[currentSelectedStyle]);
        }
    });
    getAllData();

});
var csvData;
var currentSelectedStyle = 0;
var currentSelectedBucket = "";
var currentSelectedModel = "";
function getAllData() {
    jQuery.ajax({
        url: 'api/forge/appdata/all',
        method: 'GET',
        //dataType: "json",
        //multiple: false,
        //data: function () {
        //    return { "style": "FarmHouse" };
        //},
        success: function (result) {
            //console.log(result[0]);
            csvData = result;
            csvData.forEach((element) => {
                Object.keys(element).forEach(function (key) {
                    if (key.indexOf('-') != -1) {
                        var newstr = key.replace('-', '_');
                        element[newstr] = element[key];
                        delete element[key];
                    }
                });
            });
            //console.log(Object.keys(result[0]));
            var i = 1;
            var styles = Object.keys(result[0]);
            styles.splice(0, 1);
            $('#popularityList').empty();
            result.forEach(function (item) {
                // img source should be the same as the text of the model
                // onClick here will load the corresponding 3d model
                if (i <= 9) {
                    $('#popularityList').append(`<div class="col-sm-4 inner-img" data-toggle="tooltip" data-placement="right" title="${item.Style}">
                    <img id="style${i - 1}" class="img-responsive styles" src ="images/facades/${item.Style}.jpg" alt ="${item.Style}" onClick="GetStyleData('${i-1}')" />
                                    </div >`);
                    i++;
                }
            });
            
        }
    });
}

function GetStyleData(index) {
    currentSelectedStyle = index;
    $(".styles").each(function () {
        $(this).removeClass("activeStyle");
    });
    $('#style' + index).addClass("activeStyle");
}

function logKey(e) {
    console.log("asds");
    if (e.code == 'KeyX') {
        console.log("Clicked!");
        //startWorkitem();
    }
}

function prepareLists() {
    list('activity', '/api/forge/designautomation/activities');
    list('engines', '/api/forge/designautomation/engines');
    list('localBundles', '/api/appbundles');
}

function list(control, endpoint) {
    $('#' + control).find('option').remove().end();
    jQuery.ajax({
        url: endpoint,
        success: function (list) {
            if (list.length === 0)
                $('#' + control).append($('<option>', { disabled: true, text: 'Nothing found' }));
            else
                list.forEach(function (item) { $('#' + control).append($('<option>', { value: item, text: item })); })
        }
    });
}


function fillCount( result ) {

    for (var elem in result) {
        if (elem === 'total')
            continue;
        $('#' + elem)[0].innerText = result[elem];
    }
}

function clearAccount() {
    if (!confirm('Clear existing activities & appbundles before start. ' +
        'This is useful if you believe there are wrong settings on your account.' +
        '\n\nYou cannot undo this operation. Proceed?')) return;

    jQuery.ajax({
        url: 'api/forge/designautomation/account',
        method: 'DELETE',
        success: function () {
            prepareLists();
            writeLog('Account cleared, all appbundles & activities deleted');
        }
    });
}

function defineActivityModal() {
    $("#defineActivityModal").modal();
}

function createAppBundleActivity() {
    startConnection(function () {
        writeLog("Defining appbundle and activity for " + $('#engines').val());
        $("#defineActivityModal").modal('toggle');
        createAppBundle(function () {
            createActivity(function () {
                prepareLists();
            })
        });
    });
}

function createAppBundle(cb) {
    jQuery.ajax({
        url: 'api/forge/designautomation/appbundles',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            zipFileName: $('#localBundles').val(),
            engine: $('#engines').val()
        }),
        success: function (res) {
            writeLog('AppBundle: ' + res.appBundle + ', v' + res.version);
            if (cb) cb();
        }
    });
}

function createActivity(cb) {
    jQuery.ajax({
        url: 'api/forge/designautomation/activities',
        method: 'POST',
        contentType: 'application/json',
        data: JSON.stringify({
            zipFileName: $('#localBundles').val(),
            engine: $('#engines').val()
        }),
        success: function (res) {
            writeLog('Activity: ' + res.activity);
            if (cb) cb();
        }
    });
}


function startWorkitem() {
    //let sourceNode = $('#appBuckets').jstree(true).get_selected(true)[0];
    // use == here because sourceNode may be undefined or null
    //if (sourceNode == null || sourceNode.type !== 'object' ) {
    //    alert('Can not get the selected file, please make sure you select a file as input');
    //    return;
    //}

    //let activityId = $('#activity').val();
    let activityId = "DeleteElementsActivity+dev";
    if (activityId == null) { alert('Please select an activity'); return };

    if (activityId.toLowerCase() === "countitactivity+dev"
        || activityId.toLowerCase() === "deleteelementsactivity+dev" ) {
        startConnection(function () {
            var formData = new FormData();
            formData.append('objectId', currentSelectedModel);
            formData.append('bucketId', currentSelectedBucket);
            formData.append('activityId', activityId);
            formData.append('browerConnectionId', connectionId);
            formData.append('data', JSON.stringify(csvData[currentSelectedStyle]));
            writeLog('Start checking input file...');
            $.ajax({
                url: 'api/forge/designautomation/startworkitem',
                data: formData,
                processData: false,
                contentType: false,
                type: 'POST',
                success: function (res) {
                    writeLog('Workitem started: ' + res.workItemId);
                }
            });
        });

    }
}

function writeLog(text) {
    console.log(text);
    //$('#outputlog').append('<div style="border-top: 1px dashed #C0C0C0">' + text + '</div>');
    //var elem = document.getElementById('outputlog');
    //elem.scrollTop = elem.scrollHeight;
}

var connection;
var connectionId;

function startConnection(onReady) {
    if (connection && connection.connectionState) { if (onReady) onReady(); return; }
    connection = new signalR.HubConnectionBuilder().withUrl("/api/signalr/forgecommunication").build();
    connection.start()
        .then(function () {
            connection.invoke('getConnectionId')
                .then(function (id) {
                    connectionId = id; // we'll need this...
                    //console.log(connectionId)
                    if (onReady) onReady();
                });
        });

    connection.on("downloadResult", function (url) {
        writeLog('<a href="' + url + '">Download result file here</a>');
        jQuery.ajax({
            url: '/api/forge/oss/buckets',
            method: 'GET',
            data: {
                'id': `${currentFacadeStyle}bucket`,
            },
            success: function (result) {
                var newModel;
                var biggestTime = 0;
                result.forEach(function (item) {
                    if (parseInt(item.text.split('.')[0].split('_')[0]) > biggestTime) {
                        biggestTime = parseInt(item.text.split('.')[0].split('_')[0]);
                        newModel = item;
                    }
                });
                // request that model to be viewed in the forge viewer

                $("#forgeViewer").empty();
                console.log(currentFacadeStyle);
                console.log(biggestTime);
                console.log(newModel);
                var urn = newModel.id;
                startConnection(function () {
                    jQuery.post({
                        url: '/api/forge/modelderivative/jobs',
                        contentType: 'application/json',
                        data: JSON.stringify({ 'bucketKey': currentFacadeStyle+'bucket', 'objectName': newModel.id, 'connectionId': connectionId }),
                        success: function (res) {
                            $("#mainViewImg").hide();
                            $("#forgeViewer").show();
                            $("#forgeViewer").html('Translation started! Model will load when ready..');
                            // we can load it here ba2a
                        }
                    });
                });


                //getForgeToken(function (access_token) {
                //    console.log(access_token);
                //    jQuery.ajax({
                //        url: 'https://developer.api.autodesk.com/modelderivative/v2/designdata/' + urn + '/manifest',
                //        headers: { 'Authorization': 'Bearer ' + access_token },
                //        success: function (res) {
                //            if (res.status === 'success') launchViewer(urn);
                //            else $("#forgeViewer").html('The translation job still running: ' + res.progress + '. Please try again in a moment.');
                //        },
                //        error: function (err) {
                //            var msgButton = 'This file is not translated yet! ' +
                //                '<button class="btn btn-xs btn-info" onclick="translateObject()"><span class="glyphicon glyphicon-eye-open"></span> ' +
                //                'Start translation</button>'
                //            $("#forgeViewer").html(msgButton);
                //        }
                //    });
                //})


            }
        });
    });

    connection.on("countItResult", function (result) {
        //fillCount(JSON.parse(result));
        writeLog(result);
    });
    connection.on("onComplete", function (message) {
        console.log(message);
        //let instance = $('#appBuckets').jstree(true);
        //selectNode = instance.get_selected(true)[0];
        //parentNode = instance.get_parent(selectNode);
        //instance.refresh_node(parentNode);
    });
    connection.on("extractionFinished", function (data) {
        launchViewer(data.resourceUrn);
    });

}
